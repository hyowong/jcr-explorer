<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>JCR-Explorer</title>

<!-- Core CSS - Include with every page -->
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="font-awesome/css/font-awesome.css" rel="stylesheet">

<!-- Page-Level Plugin CSS - Blank -->

<!-- SB Admin CSS - Include with every page -->
<link href="css/sb-admin.css" rel="stylesheet">


<link rel="stylesheet" href="jqtree/jqtree.css" />
<link rel="stylesheet" href="css/railscasts.css" />

<style>
 #queryTxt{
  margin:20px;
  width:80%;
  height:50px;
 }
</style>
 
</head>

<body>

	<div id="wrapper">

		<nav class="navbar navbar-default navbar-fixed-top" role="navigation"
			style="margin-bottom: 0">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".sidebar-collapse">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="index.html">JCR Explorer</a>
			</div>
			<ul class="nav navbar-top-links navbar-right">
				<li class="explore-path">/</li>
			</ul>

			<!-- /.navbar-header -->

			<div class="navbar-default navbar-static-side" role="navigation">
				<div class="sidebar-collapse" >
					<ul class="nav" id="side-menu">
						<li class="sidebar-search">
							<div class="input-group custom-search-form">
								<input type="text" class="form-control" placeholder="Search...">
								<span class="input-group-btn">
									<button class="btn btn-default" type="button">
										<i class="fa fa-search"></i>
									</button>
								</span>
							</div> <!-- /input-group -->
						</li>
						<li  >
							

							<div id="explorer" style="height:700px;overflow:auto;"></div>

						</li>

					</ul>
					<!-- /#side-menu -->
				</div>
				<!-- /.sidebar-collapse -->
			</div>
			<!-- /.navbar-static-side -->
		</nav>

		<div id="page-wrapper">
			<div class="row">
				<div class="col-lg-12">
					<strong class="page-header currentPage"></strong>
					<!-- Explorer Tree -->
					<ul class="nav nav-tabs">
						  <li class="active"><a href="#nodeDetails" id="nodeDetailsTab" data-toggle="tab">Node Details</a></li>
						  <li><a href="#query" id="queryTab" data-toggle="tab">Query</a></li>
					</ul>

					<!-- Tab panes -->
					<div class="tab-content">
					  <div class="tab-pane active" id="nodeDetails">
					<div class="jcrContent">
							<pre >
								<code class="hljs xml" id="jcrContent">
							
								</code>
							</pre>
						
					</div>
		
				 </div>
				<div class="tab-pane" id="query">
				
					<input type="text" id="queryTxt" class="queryElements"/><br/>
					<button id="executeQuery" type="button" class="btn btn-primary" data-toggle="button" class="queryElements">Execute</button>
					<div>
					
					<table class="table table-hover">
					 <thead>
					  <tr>
					  	<th>S.No</th>
					  	<th>Name</th>
					  	<th>Path</th>
					  </tr> 
					 </thead>
					 <tbody id="queryResults">
					 
					 </tbody> 
					</table>
					
					</div>
					

				</div>
					</div>
					
				</div>
				<!-- /.col-lg-12 -->
			</div>
			<!-- /.row -->
		</div>
		<!-- /#page-wrapper -->

	</div>
	<!-- /#wrapper -->

	<!-- Core Scripts - Include with every page -->
	<script src="js/jquery-1.10.2.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>

	<!-- Page-Level Plugin Scripts - Blank -->

	<!-- SB Admin Scripts - Include with every page -->
	<script src="js/sb-admin.js"></script>
	<script src="jqtree/tree.jquery.js"></script>
	<script src="js/highlight.min.js"></script>
	<script src="js/vkbeautify.js"></script>
	<script>
		var contextUrl = $(location).attr('href');
		var tree = null ;
		$(function() {
			
			tree=$('#explorer');
			makeRequest(contextUrl + "/services/explore?path=/");
			tree.bind(
					'tree.click',
					function(event) {
						var node = event.node;
						makeRequest(contextUrl + "/services/explore?path="
								+ node.id, node);
						$('.currentPage').html(node.id);
					});
		});

		function makeRequest(url, node) {
			$.getJSON(url, function(data) {
				if (!data) {
					return;
				}
				updateTree(transform(data), node);
			});
		}
		function updateTree(data, parent_node) {
			
			if (tree.tree('getTree')) {
				tree.tree('loadData', data, parent_node);
			} else {
				initTree(data);
			}
			if(parent_node && parent_node.type=='nt:folder'){
				tree.tree('openNode', parent_node);
			}
		}
		function initTree(data) {
			tree.tree({
				data : data
			});
		}

		function transform(data) {
			treeModel = [];
			if (data.length) {
				$.each(data, function(index, node) {
					if(node.name=='jcr:content'){
						displayContent(node);
						return;												
					}
					buildModel(treeModel, node);	
				});
			} else { //if single node
				buildModel(treeModel, data);
			}
			return treeModel;
		}
		
		function displayContent(node){
			if(node.properties && node.properties['jcr:data']){
				$('#jcrContent').text(vkbeautify.xml(node.properties['jcr:data'][0])).html();
				$('#nodeDetailsTab').tab('show');
			}
			$('pre code').each(function(i, e) {hljs.highlightBlock(e)});
		}

		function buildModel(treeModel, data) {
			if (data) {
				if (!data.name || data.name == '') {
					data.name = data.path;
				}
				 
				treeModel.push({
					label : data.name,
					id : data.path,
					type:(data.properties)?data.properties['jcr:primaryType'][0]:''
				});
			}
		}
		
		$('#executeQuery').click(function(){
			$.getJSON(contextUrl + "/services/query?queryStr="+$('#queryTxt').val()+"&type=JCR-SQL2", function(data) {
				if (!data) {
					return;
				}
				updateResults(data);
			});
				
		});
		
		function updateResults(data){
			$('#queryResults').html('');
			if (data.length) {
				
				var i=1;
				$.each(data, function(index, node) {
					$('#queryResults').append('<tr><td>'+(i++)+'</td><td>'+node.name+'</td><td>'+node.path+'</td></tr>');			
				});
				
			}
		}
	</script>
</body>

</html>
